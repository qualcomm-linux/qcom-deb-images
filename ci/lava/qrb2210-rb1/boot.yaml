actions:
- deploy:
    images:
      image:
        headers:
          Authentication: Q_GITHUB_TOKEN
        url: "{{BUILD_DOWNLOAD_URL}}/{{BUILD_FILE_NAME}}"
    postprocess:
      docker:
        image: ghcr.io/foundriesio/lava-lmp-sign:main
        steps:
        - export IMAGE_PATH=$PWD
        - cp overlay*.tar.gz overlay.tar.gz
        - echo "OVERLAY=overlay.tar.gz" >> $IMAGE_PATH/flash.settings
        - echo "OVERLAY_PATH=/home/" >> $IMAGE_PATH/flash.settings
        - echo "STORAGE=emmc" >> $IMAGE_PATH/flash.settings
        - echo "ROOTFS_IMAGE=disk-sdcard.img2" >> $IMAGE_PATH/flash.settings
        - echo "DEVICE_TYPE=debian-{{DEVICE_TYPE}}" >> $IMAGE_PATH/flash.settings
        - cat $IMAGE_PATH/flash.settings
    timeout:
      minutes: 200
    to: downloads
- deploy:
    images:
      image:
        url: downloads://{{BUILD_FILE_NAME}}
      settings:
        url: downloads://flash.settings
      overlay:
        url: downloads://overlay.tar.gz
    timeout:
      minutes: 5
    to: flasher
- boot:
    auto_login:
      login_prompt: 'login:'
      username: debian
      password_prompt: 'Password'
      password: debian
      login_commands:
      - "debian"
      - "new password"
      - "new password"
      - sudo su
    method: minimal
    prompts:
    - root@debian
    - debian@debian
    - "Current password"
    - "New password"
    - "Retype new password"
    timeout:
      minutes: 3
- test:
    definitions:
    - from: git
      name: "smoke-test"
      path: automated/linux/smoke/smoke.yaml
      repository: https://github.com/linaro/test-definitions.git
      parameters:
        SKIP_INSTALL: "True"
        TESTS: "pwd, uname -a, ip a"
    - from: git
      name: "wlan-smoke-test"
      path: automated/linux/wlan-smoke/wlan-smoke.yaml
      repository: https://github.com/linaro/test-definitions.git
      parameters:
        SKIP_INSTALL: "True"
- command:
    name: network_turn_on
context:
  lava_test_results_dir: /home/lava-%s
  test_character_delay: 10
device_type: {{DEVICE_TYPE}}
job_name: smoke tests {{GITHUB_REPOSITORY}} {{GITHUB_RUN_ID}}-{{GITHUB_RUN_ATTEMPT}}
metadata:
  build-commit: '{{GITHUB_SHA}}'
priority: 50
timeouts:
  job:
    minutes: 210
visibility: public
