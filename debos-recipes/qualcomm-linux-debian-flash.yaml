{{- $build_qcs615 := or .build_qcs615 "true" }}
{{- $build_qcm6490 := or .build_qcm6490 "true" }}
{{- $build_qcs8300 := or .build_qcs8300 "true" }}
{{- $build_qcs9100 := or .build_qcs9100 "true" }}
{{- $build_rb1 := "false" -}}
{{- if .u_boot_rb1 -}}
{{- $build_rb1 = "true" }}
{{- end -}}
{{- $buildid := or .buildid "" }}

{{- $target_boards := or .target_boards "all" }}

architecture: arm64

actions:
  - action: download
    description: Download qcom-ptool
    url: https://github.com/qualcomm-linux/qcom-ptool/archive/43424f96b12b357c3574d3bd8c9874b8156fde7c.tar.gz
    name: qcom-ptool
    filename: qcom-ptool.tar.gz
    unpack: true

{{- $boards := list }}
{{- if eq $build_qcs615 "true" }}
{{- $boards = append $boards (dict
    "name" "qcs615-ride"
    "silicon_family" "qcs615"
    "ptool_platforms" (list "qcs615-ride/ufs")
    "boot_binaries_download" (dict
        "description" "QCS615 boot binaries"
        "url" "https://softwarecenter.qualcomm.com/download/software/chip/qualcomm_linux-spf-1-0/qualcomm-linux-spf-1-0_test_device_public/r1.0_00108.0/qcs615-le-1-0/common/build/common/bin/QCS615_bootbinaries.zip"
        "name" "qcs615_boot-binaries"
        "filename" "qcs615_boot-binaries.zip"
        "sha256sum" "f442bd476b64312969d49e5b5369744e19ab193f0f8c05986b96307b65161a80"
    )
    "cdt_download" (dict
        "description" "QCS615 Ride CDT"
        "url" "https://artifacts.codelinaro.org/artifactory/codelinaro-le/Qualcomm_Linux/QCS615/cdt/ADP_AIR_SA6155P_V2.zip"
        "name" "qcs615-ride_cdt"
        "filename" "qcs615-ride_cdt.zip"
        "sha256sum" "37d99eb113e286400bce0d70aa12a74d05f93d01f045bf67e7a46b3c606c8fd0"
    )
    "cdt_filename" "cdt_adp_air_sa6155p.bin"
    "dtb" "qcom/qcs615-ride.dtb"
)}}
{{- end }}
{{- if eq $build_qcm6490 "true" }}
{{- $boards = append $boards (dict
    "name" "qcs6490-rb3gen2-vision-kit"
    "silicon_family" "qcm6490"
    "ptool_platforms" (list "qcs6490-rb3gen2/ufs")
    "boot_binaries_download" (dict
        "description" "QCM6490 boot binaries"
        "url" "https://softwarecenter.qualcomm.com/download/software/chip/qualcomm_linux-spf-1-0/qualcomm-linux-spf-1-0_test_device_public/r1.0_00108.0/qcm6490-le-1-0/common/build/ufs/bin/QCM6490_bootbinaries.zip"
        "name" "qcm6490_boot-binaries"
        "filename" "qcm6490_boot-binaries.zip"
        "sha256sum" "aab9817b918dc804bd47b343293fa386d2aab15fc9df620b0fe56f8f474ef97f"
    )
    "cdt_download" (dict
        "description" "RB3 Gen2 Vision Kit CDT"
        "url" "https://artifacts.codelinaro.org/artifactory/codelinaro-le/Qualcomm_Linux/QCS6490/cdt/rb3gen2-vision-kit.zip"
        "name" "qcs6490-rb3gen2-vision-kit_cdt"
        "filename" "qcs6490-rb3gen2-vision-kit_cdt.zip"
        "sha256sum" "a339e297b454c4dc3805fe8cd11d6d8dcb801aa8f0c2dc691561c2785019fa3c"
    )
    "cdt_filename" "cdt_vision_kit.bin"
    "dtb" "qcom/qcs6490-rb3gen2.dtb"
)}}
{{- end }}
{{- if eq $build_qcs8300 "true" }}
{{- $boards = append $boards (dict
    "name" "qcs8300-ride"
    "silicon_family" "qcs8300"
    "ptool_platforms" (list "qcs8300-ride-sx/ufs")
    "boot_binaries_download" (dict
        "description" "QCS8300 boot binaries"
        "url" "https://softwarecenter.qualcomm.com/download/software/chip/qualcomm_linux-spf-1-0/qualcomm-linux-spf-1-0_test_device_public/r1.0_00110.0/qcs8300-le-1-0/common/build/ufs/bin/QCS8300_bootbinaries.zip"
        "name" "qcs8300_boot-binaries"
        "filename" "qcs8300_boot-binaries.zip"
        "sha256sum" "726b3414e435257505e0f993dc7b18893fbfcc57b3c177eaace1254e72339781"
    )
    "cdt_download" (dict
        "description" "QCS8300 Ride SX EVK CDT"
        "url" "https://artifacts.codelinaro.org/artifactory/codelinaro-le/Qualcomm_Linux/QCS8300/cdt/ride-sx.zip"
        "name" "qcs8300-ride-sx_cdt"
        "filename" "qcs8300-ride-sx_cdt.zip"
        "sha256sum" "d7fc667372b28383a36d586333097d84b9d9c104f4dd1845d33904e2d6b39f80"
    )
    "cdt_filename" "cdt_ride_sx.bin"
    "dtb" "qcom/qcs8300-ride.dtb"
)}}
{{- $boards = append $boards (dict
    "name" "monaco-evk"
    "silicon_family" "qcs8300"
    "ptool_platforms" (list "iq-8275-evk/emmc" "iq-8275-evk/ufs")
    "boot_binaries_download" (dict
        "description" "QCS8300 boot binaries"
        "url" "https://softwarecenter.qualcomm.com/download/software/chip/qualcomm_linux-spf-1-0/qualcomm-linux-spf-1-0_test_device_public/r1.0_00110.0/qcs8300-le-1-0/common/build/ufs/bin/QCS8300_bootbinaries.zip"
        "name" "qcs8300_boot-binaries"
        "filename" "qcs8300_boot-binaries.zip"
        "sha256sum" "726b3414e435257505e0f993dc7b18893fbfcc57b3c177eaace1254e72339781"
    )
    "cdt_download" (dict
        "description" "IQ-8275 EVK CDT"
        "url" "https://artifacts.codelinaro.org/artifactory/codelinaro-le/Qualcomm_Linux/QCS8300/cdt/qcs8275-iq-8275-evk-pro-sku.zip"
        "name" "iq8275-evk-pro_cdt"
        "filename" "qcs8275-iq-8275-evk-pro-sku.zip"
        "sha256sum" "cbe2009c8ef7dbacd716141bf01b8e1b26788c4a4f3145e60fe3b4a6b3aabc04"
    )
    "cdt_filename" "cdt_qcs8275_iq_8275_evk_pro_sku.bin"
    "dtb" "qcom/monaco-evk.dtb"
)}}
{{- end }}
{{- if eq $build_qcs9100 "true" }}
{{- $boards = append $boards (dict
    "name" "qcs9100-ride-r3"
    "silicon_family" "qcs9100"
    "ptool_platforms" (list "qcs9100-ride-sx/ufs")
    "boot_binaries_download" (dict
        "description" "QCS9100 boot binaries"
        "url" "https://softwarecenter.qualcomm.com/download/software/chip/qualcomm_linux-spf-1-0/qualcomm-linux-spf-1-0_test_device_public/r1.0_00108.0/qcs9100-le-1-0/common/build/ufs/bin/QCS9100_bootbinaries.zip"
        "name" "qcs9100_boot-binaries"
        "filename" "qcs9100_boot-binaries.zip"
        "sha256sum" "6f1e31e51521f644791638c80ac9feb19b7170eb8e65f8f0c28559cc8a6bc264"
    )
    "cdt_download" (dict
        "description" "QCS9100 Ride Rev3 EVK CDT"
        "url" "https://artifacts.codelinaro.org/artifactory/codelinaro-le/Qualcomm_Linux/QCS9100/cdt/ride-sx_v3.zip"
        "name" "qcs9100-ride-sx-v3_cdt"
        "filename" "qcs9100-ride-sx-v3_cdt.zip"
        "sha256sum" "377a8405899ac82199deaf70bca3648c15b924a3fcef8f109555e661ed70f4b9"
    )
    "cdt_filename" "cdt_ride_sx.bin"
    "dtb" "qcom/qcs9100-ride-r3.dtb"
)}}
{{- $boards = append $boards (dict
    "name" "lemans-evk"
    "silicon_family" "qcs9075"
    "ptool_platforms" (list "iq-9075-evk/ufs")
    "boot_binaries_download" (dict
        "description" "QCS9100 boot binaries"
        "url" "https://softwarecenter.qualcomm.com/download/software/chip/qualcomm_linux-spf-1-0/qualcomm-linux-spf-1-0_test_device_public/r1.0_00108.0/qcs9100-le-1-0/common/build/ufs/bin/QCS9100_bootbinaries.zip"
        "name" "qcs9100_boot-binaries"
        "filename" "qcs9100_boot-binaries.zip"
        "sha256sum" "6f1e31e51521f644791638c80ac9feb19b7170eb8e65f8f0c28559cc8a6bc264"
    )
    "cdt_download" (dict
        "description" "QCS9100 RB8 Core Kit CDT"
        "url" "https://artifacts.codelinaro.org/artifactory/codelinaro-le/Qualcomm_Linux/QCS9100/cdt/rb8_core_kit.zip"
        "name" "qcs9100-rb8-core-kit_cdt"
        "filename" "qcs9100-rb8-core-kit_cdt.zip"
        "sha256sum" "a252244f800d7c9e15883e12935af4113f9f2ecba6490e46cd9b943169f15bfa"
    )
    "cdt_filename" "cdt_rb8_core_kit.bin"
    "dtb" "qcom/lemans-evk.dtb"
)}}
{{- end }}
{{- if eq $build_rb1 "true" }}
{{- $boards = append $boards (dict
    "name" "qrb2210-rb1"
    "silicon_family" "qcm2290"
    "ptool_platforms" (list "qrb2210-rb1/emmc")
    "boot_binaries_download" (dict
        "description" "RB1 rescue image"
        "url" "https://artifacts.codelinaro.org/artifactory/clo-549-96boards-backup/96boards/rb1/linaro/rescue/23.12/rb1-bootloader-emmc-linux-47528.zip"
        "name" "qrb2210-rb1_rescue-image"
        "filename" "qrb2210-rb1_rescue-image.zip"
        "sha256sum" "c75b6c63eb24c8ca36dad08ba4d4e93f3f4cd7dce60cf1b6dfb5790dc181cc3d"
    )
    "u_boot_file" .u_boot_rb1
    "dtb" "qcom/qrb2210-rb1.dtb"
)}}
{{- end }}

{{- range $board := $boards }}
  - action: download
    description: Download of {{ $board.boot_binaries_download.description }}
    url: {{ $board.boot_binaries_download.url }}
    name: {{ $board.boot_binaries_download.name }}
    filename: {{ $board.boot_binaries_download.filename }}
  - action: run
    description: Verify SHA256 sum of {{ $board.boot_binaries_download.description }}
    chroot: false
    command:
      echo "{{ $board.boot_binaries_download.sha256sum }} ${ROOTDIR}/../{{ $board.boot_binaries_download.filename }}" |
          sha256sum --strict -c -
  {{- if $board.cdt_download }}
  - action: download
    description: Download of {{ $board.cdt_download.description }}
    url: {{ $board.cdt_download.url }}
    name: {{ $board.cdt_download.name }}
    filename: {{ $board.cdt_download.filename }}
  - action: run
    description: Verify SHA256 sum of {{ $board.cdt_download.description }}
    chroot: false
    command:
      echo "{{ $board.cdt_download.sha256sum }} ${ROOTDIR}/../{{ $board.cdt_download.filename }}" |
          sha256sum --strict -c -
  {{- end }}
{{- end }}

  - action: run
    description: Generate flash directories for eMMC and UFS boards
    chroot: false
    command: |
      set -eux
      # work dir that will be thrown away
      mkdir -v build

      # path to unpacked qcom-ptool tarball
      QCOM_PTOOL="$(ls -d "${ROOTDIR}/../qcom-ptool.tar.gz.d/qcom-ptool-"*)"

      # build a list of supported dtbs from the dtbs tarball
      dtbs_file="build/dtbs.txt"
      : >"${dtbs_file}"
      if [ -f "${ARTIFACTDIR}/dtbs.tar.gz" ]; then
          tar -tzf "${ARTIFACTDIR}/dtbs.tar.gz" --wildcards '*.dtb' \
              >>"$dtbs_file"
      fi

      # optional list of board names to build
      targets_file="build/targets.txt"
      rm -f "${targets_file}"
      case "{{ $target_boards }}" in
        all)
          # no override; build all possible boards (default)
          touch "${targets_file}"
{{- range $board := $boards }}
          echo "{{ $board.name }}" >>"${targets_file}"
{{- end }}
          ;;
        *)
          echo "{{ $target_boards }}" |
              tr ',' '\n' |
              sed '/^$/d' |
              sort -u >"${targets_file}"
          ;;
      esac

{{- range $board := $boards }}
      ### board: {{ $board.name }}
      ### silicon family: {{ $board.silicon_family }}

      # set skip_board if board isn't listed
      skip_board=false
      if ! grep -Fxq "{{ $board.name }}" "${targets_file}"; then
          skip_board=true
          echo "Skipping board {{ $board.name }}: not in target list"
      fi

      # set skip_board if board dtb isn't present
      if ! grep -Fxq "{{ $board.dtb }}" "${dtbs_file}"; then
          skip_board=true
          echo "Skipping board {{ $board.name }}: dtb not available"
      fi


      # unpack boot binaries
      mkdir -v build/{{ $board.name }}_boot-binaries
      unzip "${ROOTDIR}/../{{ $board.boot_binaries_download.filename }}" \
          -d build/{{ $board.name }}_boot-binaries/unpack
      # strip top directories
      mv build/{{ $board.name }}_boot-binaries/unpack/*/* build/{{ $board.name }}_boot-binaries
      rmdir -v build/{{ $board.name }}_boot-binaries/unpack/* build/{{ $board.name }}_boot-binaries/unpack

  {{- if $board.cdt_download }}
      if [ "${skip_board}" = false ]; then
          # unpack board CDT
          unzip "${ROOTDIR}/../{{ $board.cdt_download.filename }}" \
              -d build/{{ $board.name }}_cdt
      fi
  {{- end }}

{{- range $platform := $board.ptool_platforms }}
      ### platform: {{ $platform }}

      # generate ptool files - various XML files for flashing, GPT data etc.
      mkdir -vp build/ptool/{{ $platform }}
      (
          cd build/ptool/{{ $platform }}
          conf="${QCOM_PTOOL}/platforms/{{ $platform }}/partitions.conf"
          contents="${QCOM_PTOOL}/platforms/{{ $platform }}/contents.xml.in"
          disk_type="unknown"
          # make a copy of partitions.conf; infer storage type from lines
          # like:
          #     --disk --type=ufs --size=137438953472 ...
          # or:
          #     --disk --type=emmc --size=76841669632 ...
          # and patch/add filenames for partitions from lines like:
          #     --partition --lun=4 --name=dtb_a ... --filename=dtb.bin
          # or without filename like:
          #     --partition --lun=3 --name=cdt --size=128KB --type-guid=...
          # for data from the following table
          #
          # |--------|--------------|-------------------|-----------------|
          # | data   | ptool name   | ptool filename    | debos filename  |
          # |--------|--------------|-------------------|-----------------|
          # | ESP    | efi          | efi.bin           | disk-media.img1 |
          # | rootfs | rootfs       | rootfs.img        | disk-media.img2 |
          # | DTBs   | dtb_a, dtb_b | dtb.bin           | dtb.bin         |
          # | CDTs   | cdt          | unset / per board | from download   |
          # |--------|--------------|-------------------|-----------------|
          while read line; do
              case "$line" in
                # detect storage type
                "--disk "*)
                  disk_type="$(echo "$line" | sed -n 's/.*--type=\([^ ]*\).*/\1/p')"
                  case $disk_type in
                    "emmc")
                      esp="../disk-sdcard.img1"
                      rootfs="../disk-sdcard.img2"
                      ;;
                    "ufs")
                      esp="../disk-ufs.img1"
                      rootfs="../disk-ufs.img2"
                      ;;
                  esac
                  echo "$disk_type" >disk_type
                  ;;
                # read partitions
                "--partition "*)
                  name="$(echo "$line" | sed -n 's/.*--name=\([^ ]*\).*/\1/p')"
                  filename=""
                  case "$name" in
                    dtb_a|dtb_b) filename="dtb.bin";;
                    efi) filename="$esp";;
                    rootfs) filename="$rootfs";;
                    {{- if $board.cdt_download }}
                    cdt) filename={{ $board.cdt_filename }};;
                    {{- end }}
                  esac
                  # override/set filename
                  if [ -n "$filename" ]; then
                      line="$(echo "$line" | sed 's/ --filename=[^ ]*//')"
                      line="${line} --filename=${filename}"
                  fi
                  ;;
              esac
              echo "$line"
          done <"$conf" >partitions.conf
          # generate ptool-partitions.xml from partitions.conf
          "${QCOM_PTOOL}/gen_partition.py" -i partitions.conf \
              -o ptool-partitions.xml
          # generate contents.xml from ptool-partitions.xml and contents.xml.in
          if [ -e "$contents" ]; then
              "${QCOM_PTOOL}/gen_contents.py" -p ptool-partitions.xml \
                  -t "$contents" \
                  -b "{{$buildid}}" \
                  -o contents.xml
          fi
          # generate flashing files from qcom-partitions.xml
          "${QCOM_PTOOL}/ptool.py" -x ptool-partitions.xml
      )

      if [ "${skip_board}" = false ]; then
          disk_type=$(cat build/ptool/{{ $platform }}/disk_type)
          # create board-specific flash directory
          flash_dir="${ARTIFACTDIR}/flash_{{ $board.name }}_${disk_type}"
          rm -rf "${flash_dir}"
          mkdir -v "${flash_dir}"
          # copy platform partition files
          cp --preserve=mode,timestamps -v \
              build/ptool/{{ $platform }}/* "${flash_dir}"
          # adjust paths in contents.xml to use board-specific flash_* subdir
          if [ -e "${flash_dir}/contents.xml" ]; then
              # one set of backslashes for shell quoting, another one for sed
              # parsing
              windows_path=".\\\\flash_{{ $board.name }}_${disk_type}\\\\"
              linux_path="./flash_{{ $board.name }}_${disk_type}/"
              sed -i \
                  -e "s:<windows_root_path>.*:<windows_root_path>${windows_path}</windows_root_path>:" \
                  -e "s:<linux_root_path>.*:<linux_root_path>${linux_path}</linux_root_path>:" \
                  "${flash_dir}/contents.xml"
          fi
          # remove BLANK_GPT and WIPE_PARTITIONS files as it's common for
          # people to run "qdl rawprogram*.xml", mistakingly including these;
          # perhaps ptool should have a flag not to generate these; note that
          # there are wipe_rawprogram*.xml files still
          rm -v "${flash_dir}"/rawprogram*_BLANK_GPT.xml
          rm -v "${flash_dir}"/rawprogram*_WIPE_PARTITIONS.xml
          # copy silicon family boot binaries; these shouldn't ship partition
          # files, but make sure not to accidentally clobber any such file
          find build/{{ $board.name }}_boot-binaries \
              -not -name 'gpt_*' \
              -not -name 'patch*.xml' \
              -not -name 'rawprogram*.xml' \
              -not -name 'wipe*.xml' \
              -not -name 'zeros_*' \
              \( \
                  -name LICENSE \
                  -or -name Qualcomm-Technologies-Inc.-Proprietary \
                  -or -name 'prog_*' \
                  -or -name '*.bin' \
                  -or -name '*.elf' \
                  -or -name '*.fv' \
                  -or -name '*.mbn' \
              \) \
              -exec cp --preserve=mode,timestamps -v '{}' "${flash_dir}" \;

          # remove the temporary disk_type file from the flash dir
          rm -f "${flash_dir}/disk_type"
      fi
  {{- if $board.u_boot_file }}
      if [ "${skip_board}" = false ]; then
          # copy U-Boot binary to boot.img;
          # qcom-ptool/platforms/*/partitions.conf uses filename=boot.img
          # boot_a and boot_b partitions
          cp --preserve=mode,timestamps -v \
              "${ARTIFACTDIR}/{{ $board.u_boot_file }}" "${flash_dir}/boot.img"
      fi
  {{- end }}

  {{- if $board.cdt_download }}
      if [ "${skip_board}" = false ]; then
          # copy just the CDT data; no partition or flashing files
          cp --preserve=mode,timestamps -v \
              build/{{ $board.name }}_cdt/{{ $board.cdt_filename }} \
              "${flash_dir}"
      fi
  {{- end }}

      if [ "${skip_board}" = false ]; then
          # generate a dtb.bin FAT partition with just a single dtb for the
          # current board; long-term this should really be a set of dtbs and
          # overlays as to share dtb.bin across boards
          dtb_bin="${flash_dir}/dtb.bin"
          rm -f "${dtb_bin}"
          # dtb.bin is only used in UFS based boards at the moment and UFS
          # uses a 4k sector size, so pass -S 4096 in
          # qcom-ptool/platforms/*/partitions.conf, dtb_a and _b partitions
          # are provisioned with 64MiB; create a 4MiB FAT that will
          # comfortably fit in these and hold the target device tree, which is
          # 4096 KiB sized blocks for mkfs.vfat's last argument
          mkfs.vfat -S 4096 -C "${dtb_bin}" 4096
          # extract board device tree from the root filesystem provided
          # tarball
          tar -C build -xvf "${ARTIFACTDIR}/dtbs.tar.gz" "{{ $board.dtb }}"
          # copy into the FAT as combined-dtb.dtb
          mcopy -vmp -i "${dtb_bin}" "build/{{ $board.dtb }}" \
              ::/combined-dtb.dtb
      fi
{{- end }}
{{- end }}

      # cleanup
      rm -rf build

# Copyright (c) Qualcomm Technologies, Inc. and/or its subsidiaries.
# SPDX-License-Identifier: BSD-3-Clause
